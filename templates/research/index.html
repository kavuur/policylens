{% extends "base.html" %}

{% block title %}Policy Research Assistant - Policy Lens{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="text-center mb-5">
                <h1 class="display-4 text-success mb-3">Policy Research Assistant</h1>
                <p class="lead">AI-powered assistant to help in drafting policy documents</p>
            </div>

            <!-- Upload Section -->
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Upload Document</h5>
                </div>
                <div class="card-body">
                    <form id="documentUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">Upload a document (PDF or DOCX)</label>
                            <input class="form-control" type="file" id="documentFile" accept=".pdf,.docx" required>
                            <div class="form-text">Supported formats: .pdf, .docx (Max 10MB)</div>
                        </div>
                        <button type="submit" class="btn btn-success" id="uploadButton">
                            <i class="fas fa-upload me-2"></i>Upload & Analyze
                        </button>
                        <!-- Add this right after the <button type="submit" ...>Upload & Analyze</button> -->
<button type="button" class="btn btn-outline-primary ms-2" onclick="window.location.href='/live_writing'">
    <i class="fas fa-edit me-2"></i>Live Writing Assisted by AI
</button>
                    </form>
                </div>
            </div>

            <!-- AI Suggestions Section -->
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI-Powered Suggestions</h5>
                    <button class="btn btn-sm btn-light" id="copySuggestions" disabled>
                        <i class="far fa-copy me-1"></i> Copy
                    </button>
                </div>
                <div class="card-body">
                    <div id="suggestionsContainer" class="p-3 bg-light rounded" style="min-height: 200px;">
                        <p class="text-muted text-center my-5" id="defaultSuggestion">
                            <i class="fas fa-arrow-up me-2"></i>
                            Upload a document to get AI-powered suggestions for improvements.
                        </p>
                        <div id="suggestionsContent" class="d-none">
                            <!-- AI suggestions will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Handle file upload
    $('#documentUploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('documentFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('Please select a file to upload.', 'danger');
            return;
        }
        
        // FormData for file upload
        const formData = new FormData();
        formData.append('file', file);

        // Show loading state
        const uploadBtn = $('#uploadButton');
        const originalBtnText = uploadBtn.html();
        uploadBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analyzing...');

        // AJAX upload and analysis
        $.ajax({
            url: '/analyze_policy',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                uploadBtn.prop('disabled', false).html(originalBtnText);
                if (response.success) {
                    showAlert('Document analyzed successfully! View suggestions below.', 'success');
                    displayResults(response.suggestions, response.evidence, response.keywords);
                } else {
                    showAlert(response.error || 'Analysis failed.', 'danger');
                }
            },
            error: function(xhr) {
                uploadBtn.prop('disabled', false).html(originalBtnText);
                const err = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed. Please try again.';
                showAlert(err, 'danger');
            }
        });
    });

    // Display results
    function displayResults(suggestions, evidence, keywords) {
        let html = `
            <h6 class="mb-3 text-primary">Derived Keywords: ${keywords.join(', ')}</h6>
            <h6 class="mb-3">Improvement Suggestions:</h6>
            <div class="suggestions-text mb-4">${suggestions.replace(/\n/g, '<br>')}</div>
        `;

        if (evidence && evidence.length > 0) {
            html += `
                <h6 class="mb-3">Supporting Evidence Sources:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr><th>Title</th><th>Source</th><th>Snippet</th><th>Link</th></tr>
                        </thead>
                        <tbody>
            `;
            evidence.forEach(function(item) {
                html += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.source}</td>
                        <td>${item.snippet}</td>
                        <td><a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary">View PDF</a></td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
        } else {
            html += '<p class="text-muted">No relevant evidence sources found.</p>';
        }

        $('#defaultSuggestion').addClass('d-none');
        $('#suggestionsContent').removeClass('d-none').html(html);
        $('#copySuggestions').prop('disabled', false).off('click').on('click', function() {
            const text = $('#suggestionsContent').text();
            navigator.clipboard.writeText(text).then(() => showAlert('Suggestions copied!', 'success'));
        });
    }

    // Helper for alerts (unchanged)
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('.alert').alert('close');
        $('.container').prepend(alertHtml);
    }
});
</script>

<style>
/* Existing styles unchanged */
#suggestionsContainer { min-height: 200px; transition: all 0.3s ease; }
.suggestions-text { white-space: pre-wrap; font-size: 0.95em; line-height: 1.5; }
.table th { font-size: 0.9em; }
.table td { vertical-align: middle; }
#defaultSuggestion { opacity: 0.7; }
</style>
{% endblock %}
